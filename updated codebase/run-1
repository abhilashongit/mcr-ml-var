import pandas as pd
import numpy as np
import xgboost as xgb
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_error

# --- 1. DATA INGESTION & ROBUST CLEANING cleans ---
train_file = 'Crude Oil WTI- Daily 2019-2024.csv'
test_file = '2025 daily data.xlsx - Sheet1.csv'

def load_and_standardize(path, is_train=True):
    # Read CSV
    df = pd.read_csv(path)
    
    # Fix Dates: Train is DD-MM-YYYY, Test is YYYY-MM-DD
    df['Date'] = pd.to_datetime(df['Date'], dayfirst=True if is_train else False)
    
    # Standardize Column Names
    if is_train:
        df = df.rename(columns={'Vol.': 'Volume', 'Change %': 'Change_Pct'})
    else:
        df = df.rename(columns={'Change': 'Change_Pct'})
    
    # Clean Volume: Convert "150K" or "1M" to float
    df['Volume'] = df['Volume'].astype(str).replace({'K': '*1e3', 'M': '*1e6', ',': ''}, regex=True).map(pd.eval).astype(float)
    
    # Clean Change %: Ensure both are decimals (e.g., 1.02% -> 0.0102)
    if is_train:
        df['Change_Pct'] = df['Change_Pct'].astype(str).str.replace('%', '').astype(float) / 100
    
    # Sort and aggregate to Weekly
    df = df.sort_values('Date').set_index('Date')
    weekly = df.resample('W-MON').agg({
        'High': 'max',
        'Low': 'min',
        'Price': 'last',
        'Volume': 'sum',
        'Change_Pct': 'mean'
    }).dropna()
    
    # Dependent Variable: Weekly Range
    weekly['Range'] = weekly['High'] - weekly['Low']
    return weekly

# Load dataframes
train_weekly = load_and_standardize(train_file, is_train=True)
test_weekly = load_and_standardize(test_file, is_train=False)

# --- 2. VOLATILITY WEIGHTING LOGIC ---
def prepare_features(df, apply_weights=False):
    df = df.copy()
    # Independent Variables: Lagged volume and lagged change to predict current range
    df['Lag_Vol'] = df['Volume'].shift(1)
    df['Lag_Change'] = df['Change_Pct'].shift(1).abs() # Absolute movement intensity
    df['Lag_Range'] = df['Range'].shift(1)
    df = df.dropna()
    
    weights = None
    if apply_weights:
        # Calculate Volatility Variance (Rolling Std Dev of the Range)
        # Higher volatility = Higher weight in the Loss Function
        vol_variance = df['Range'].rolling(window=4).std().fillna(df['Range'].std())
        weights = (vol_variance / vol_variance.mean()).values
        
    return df, weights

train_df, train_w = prepare_features(train_weekly, apply_weights=True)
test_df, _ = prepare_features(test_weekly)

# --- 3. XGBOOST MODEL (WLS APPROACH) ---
X_train = train_df[['Lag_Vol', 'Lag_Change', 'Lag_Range']]
y_train = train_df['Range']

X_test = test_df[['Lag_Vol', 'Lag_Change', 'Lag_Range']]
y_actual = test_df['Range']

# Model tuned for dynamic responsiveness
model = xgb.XGBRegressor(
    objective='reg:squarederror',
    n_estimators=1500,
    learning_rate=0.02,
    max_depth=7,
    subsample=0.9,
    colsample_bytree=0.9,
    random_state=42
)

# Fit model using the calculated volatility weights
model.fit(X_train, y_train, sample_weight=train_w)

# --- 4. PREDICTIONS & OUTPUT ---
preds = model.predict(X_test)
test_df['Estimated_Range_2025'] = preds

# Save to Excel
test_df[['Range', 'Estimated_Range_2025']].to_excel('Weekly_Estimated_Range_2025.xlsx')
print("Successfully generated: Weekly_Estimated_Range_2025.xlsx")

# --- 5. VISUALIZATION ---
plt.figure(figsize=(14, 6))
plt.plot(test_df.index, y_actual, label='Actual Range (2025)', color='black', alpha=0.6, linewidth=2)
plt.plot(test_df.index, preds, label='XGBoost Estimated Range (WLS)', color='red', linestyle='--', linewidth=2)

plt.fill_between(test_df.index, y_actual, preds, color='red', alpha=0.1, label='Prediction Delta')
plt.title('Crude Oil WTI: Weekly Price Range Prediction (Volatility-Weighted)')
plt.ylabel('Price Movement Range ($)')
plt.xlabel('2025 Timeline')
plt.legend()
plt.grid(True, linestyle=':', alpha=0.7)
plt.show()

mae = mean_absolute_error(y_actual, preds)
print(f"Final Model MAE: {mae:.4f}")
